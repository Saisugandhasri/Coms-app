<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Listening Comprehension</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
    }

    .question {
      margin-bottom: 20px;
      padding: 10px;
      border: 1px solid #8cb6db;
    }

    .one-word {
      margin-bottom: 15px;
    }

    .submit-btn {
      margin-top: 20px;
      padding: 10px 20px;
    }

    .score {
      margin-top: 30px;
      padding: 15px;
      background: #f3f3f3;
      border: 1px solid #ccc;
    }

    .topic {
      font-weight: bold;
    }

    .replay {
      margin-top: 10px;
      font-size: 14px;
    }
  </style>
</head>

<body>

  <h2>Listening Comprehension</h2>
  <button onclick="startListening()">Start Listening Assessment</button>

  <hr />

  <div id="topic" class="topic"></div>
  <div id="audio-container"></div>
  <div id="replay-info" class="replay"></div>

  <h3 class="h3-mcqs" style="display:none">MCQs</h3>
  <div id="questions"></div>

  <h3 class="h3-one_word" style="display:none">One-Word Questions</h3>
  <div id="one-word"></div>

  <button class="submit-btn" onclick="submitAssessment()" style="display:none;">Submit</button>
  <div id="result" class="score"></div>

  <script>
    let assessmentId = null;
    let mcqAnswers = {};
    let oneWordAnswers = {};
    let totalMcqs = 0;
    let totalOneWords = 0;
    let isSubmitted = false;

    let maxReplays = 3;
    let remainingReplays = 3;




    async function startListening() {

      document.querySelector(".submit-btn").style.display = "none";
      document.querySelector(".h3-mcqs").style.display = "none";
      document.querySelector(".h3-one_word").style.display = "none";

      mcqAnswers = {};
      oneWordAnswers = {};
      isSubmitted = false;
      document.querySelector(".submit-btn").disabled = false;
      document.getElementById("questions").innerHTML = "";
      document.getElementById("one-word").innerHTML = "";
      document.getElementById("result").innerHTML = "";
      document.getElementById("audio-container").innerHTML = "";
      document.getElementById("replay-info").innerHTML = "";

      const response = await fetch("http://localhost:8000/assessment/listening/start", {
        method: "POST"
      });

      const data = await response.json();
      assessmentId = data.assessment_id;
      totalMcqs = data.mcqs.length;
      totalOneWords = data.one_word_questions.length;

      maxReplays = data.max_replays || 3;
      remainingReplays = maxReplays;

      document.getElementById("topic").innerText = `Topic: ${data.topic}`;

      document.getElementById("audio-container").innerHTML = `
    <audio id="audioPlayer" controls>
      <source src="${data.audio_url}" type="audio/mpeg">
    </audio>
    <br><br>
    Speed:
    <select onchange="audioPlayer.playbackRate=this.value">
      <option value="0.75">0.75×</option>
      <option value="1" selected>1×</option>
      <option value="1.25">1.25×</option>
    </select>
  `;

      const audio = document.getElementById("audioPlayer");

      audio.addEventListener("play", () => {
        if (remainingReplays <= 0) {
          audio.pause();
          alert("Replay limit reached.");
          return;
        }
      });

      audio.addEventListener("ended", () => {
        remainingReplays--;
        updateReplayInfo();

        if (remainingReplays <= 0) {
          audio.controls = false;
        }
      });

      updateReplayInfo();

      // MCQs
      data.mcqs.forEach((q, i) => {
        let html = `<div class="question"><b>Q${i + 1}. ${q.question}</b><br>`;
        Object.entries(q.options).forEach(([k, v]) => {
          html += `
        <label>
          <input type="radio" name="mcq${i}"
                 onchange="mcqAnswers['${i}']='${k}'">
          ${k}. ${v}
        </label><br>`;
        });
        html += "</div>";
        document.getElementById("questions").innerHTML += html;
      });

      // One-word
      data.one_word_questions.forEach((q, i) => {
        document.getElementById("one-word").innerHTML += `
      <div class="one-word">
        <b>Q${i + 1}. ${q.question}</b><br>
        <input type="text"
               oninput="oneWordAnswers['${i}']=this.value.trim()">
      </div>
    `;
      });
      document.querySelector(".submit-btn").style.display = "inline-block";
      document.querySelector(".h3-mcqs").style.display = "inline-block";
      document.querySelector(".h3-one_word").style.display = "inline-block";

    }

    function updateReplayInfo() {
      document.getElementById("replay-info").innerText =
        `Remaining replays: ${remainingReplays} / ${maxReplays}`;
    }

    async function submitAssessment() {
      if (isSubmitted) return;

      // Validation
      const answeredMcqs = Object.keys(mcqAnswers).length;
      const filledOneWords = Object.values(oneWordAnswers).filter(v => v !== "").length;

      if (answeredMcqs < totalMcqs || filledOneWords < totalOneWords) {
        const resultDiv = document.getElementById("result");
        resultDiv.innerHTML = "<h3 style='color: red;'>Please answer all questions before submitting.</h3>";
        return;
      }

      const response = await fetch("http://localhost:8000/assessment/submit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          assessment_id: assessmentId,
          answers: {
            mcqs: mcqAnswers,
            one_word: oneWordAnswers
          }
        })
      });

      const data = await response.json();
      document.getElementById("result").innerHTML =
        `<h3>Score: ${data.score}</h3>`;

      isSubmitted = true;
      document.querySelector(".submit-btn").disabled = true;

      // Display correct answers
      const correctAnswers = data.correct_answers;

      // MCQs
      Object.entries(correctAnswers.mcqs).forEach(([idx, answer]) => {
        const questionDiv = document.querySelectorAll("#questions .question")[idx];
        if (questionDiv) {
          const userSelected = mcqAnswers[idx];
          if (userSelected && userSelected !== answer) {
            const labels = questionDiv.querySelectorAll('label');
            labels.forEach(label => {
              if (label.innerText.trim().startsWith(userSelected + ".")) {
                label.style.color = "red";
                label.style.fontWeight = "bold";
                label.innerHTML += "(Your Answer)";
              }
            });
          }

          const answerDiv = document.createElement("div");
          answerDiv.style.color = "green";
          answerDiv.style.fontWeight = "bold";
          answerDiv.innerText = `Correct Answer: ${answer}`;
          questionDiv.appendChild(answerDiv);
        }
      });

      // One-word
      Object.entries(correctAnswers.one_word).forEach(([idx, answer]) => {
        const questionDiv = document.querySelectorAll("#one-word .one-word")[idx];
        if (questionDiv) {
          const input = questionDiv.querySelector('input');
          const userAns = oneWordAnswers[idx] || "";
          if (userAns.toLowerCase().trim() !== answer.toLowerCase().trim()) {
            input.style.border = "2px solid red";
            input.style.color = "red";

            const wrongDiv = document.createElement("div");
            wrongDiv.style.color = "red";
            wrongDiv.innerText = `Your Answer: ${userAns}`;
            questionDiv.appendChild(wrongDiv);
          }

          const answerDiv = document.createElement("div");
          answerDiv.style.color = "green";
          answerDiv.style.fontWeight = "bold";
          answerDiv.innerText = `Correct Answer: ${answer}`;
          questionDiv.appendChild(answerDiv);
        }
      });
    }
  </script>

</body>

</html>